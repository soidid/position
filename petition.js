(function(){var e,t,a,i,s,n,r,o,h,l,d,u,p,m,c;e=React.DOM,t=e.div,a=e.img,i=e.form,s=e.button,n=e.label,r=e.input,o=e.span,h=e.em,l="https://99fireman.firebaseio.com/",d=React.createClass({displayName:"PetitionApp",mixins:[ReactFireMixin],getInitialState:function(){return{data:[],user:null,isPetitioned:!1}},componentWillMount:function(){var e=this;return this.bindAsArray(new Firebase(l+"/issues/fireman-owyeu8i3t7l7rves/petitioners"),"data"),this.auth=new FirebaseSimpleLogin(this.firebaseRefs.data,function(t,a){var i,s;return t?console(t):a?(i=a.uid,e.setState({user:a}),s=e.firebaseRefs.data.child(i+""),s.on("child_added",function(t){return t.val()?e.setState({isPetitioned:!0}):void 0})):e.setState({user:null})})},handlePetitionSubmit:function(e){var t,a,i;return t=e.uid,a=e.email,delete e.email,i=this.state.data,i.push(e),this.setState({data:i}),this.firebaseRefs.data.child(t+"").setWithPriority(e,Firebase.ServerValue.TIMESTAMP),this.firebaseRefs.data.root().child("users/"+t).setWithPriority({email:a},Firebase.ServerValue.TIMESTAMP)},handleLogin:function(){return this.auth.login("facebook",{rememberMe:!0,scope:"email"})},handleLogout:function(){return this.auth.logout()},render:function(){return t({},this.state.user?m({handleClick:this.handleLogout,message:"臉書登出"}):m({handleClick:this.handleLogin,message:"臉書登入"}),this.state.user&&!this.state.isPetitioned?c({onPetitionSubmit:this.handlePetitionSubmit,uid:this.state.user.uid,displayName:this.state.user.displayName,email:this.state.user.thirdPartyUserData.email,avatarURL:this.state.user.thirdPartyUserData.picture.data.url}):void 0,this.state.isPetitioned&&this.state.user?t({className:"done"},"我已連署過"):void 0,u({data:this.state.data}))}}),u=React.createClass({displayName:"PetitionList",render:function(){var e,a;return e=0,a=this.props.data.map(function(t){var a,i,s;return a=t.displayName,i=t.avatarURL,s=t.hiddenMe,s?void 0:(e+=1,p({author:a,avatar:i}))}),t({className:"petition-list"},t({className:"issue-petitioners"},"目前已經有 "+this.props.data.length+" 人連署"),t({className:"petitioners"},{personNodes:a},this.props.data.length-e>0?o({className:"more"},"...以及其他"+(this.props.data.length-e)+"人。"):void 0))}}),p=React.createClass({displayName:"PetitionPerson",componentDidMount:function(){return $(this.getDOMNode()).popup()},render:function(){var e;return e=this.props.author,this.props.author.length>=15&&(e=this.props.author.substring(0,15)+"..."),t({className:"petitioner","data-content":this.props.author},a({src:this.props.avatar}),t({className:"name"},e))}}),m=React.createClass({displayName:"FBAuthButton",render:function(){return s({onClick:this.props.handleClick},this.props.message)}}),c=React.createClass({displayName:"PetitionForm",getInitialState:function(){return{displayName:this.props.displayName||"",email:this.props.email||"",uid:this.props.uid||"",avatarURL:this.props.avatarURL||"",hiddenMe:!1}},handleNameChange:function(e){return this.setState({displayName:e.target.value})},handleEmailChange:function(e){return this.setState({email:e.target.value})},handleDisplayCheck:function(e){return this.setState({hiddenMe:e.target.checked})},handleSubmit:function(e){var t,a,i,s,n,r;return e.preventDefault(),t=this.state,a=t.displayName,i=t.email,s=t.uid,n=t.avatarURL,r=t.hiddenMe,console.log(r),a||i||s||n?(a=a.trim(),this.props.onPetitionSubmit({displayName:a,email:i,uid:s,avatarURL:n,hiddenMe:r})):void 0},render:function(){return i({onSubmit:this.handleSubmit},t({className:"field"},n({},"顯示名稱"),r({type:"text",value:this.state.displayName,onChange:this.handleNameChange})),t({className:"field"},n({},"Email"),r({type:"email",value:this.state.email,onChange:this.handleEmailChange})),t({className:"field"},r({type:"checkbox",checked:this.state.hiddenMe,onChange:this.handleDisplayCheck},"不要顯示頭像")),r({type:"hidden",value:this.state.uid}),r({type:"hidden",value:this.state.avatarURL}),s({type:"submit",onSubmit:this.handleSubmit},"我要連署"))}}),React.renderComponent(d(),document.getElementById("petition_component"))}).call(this);